<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Guru - SD Lazuardi</title>

<style>
body{
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#64b5f6,#2196f3);
    margin:0;padding:20px;
}
.container{
    max-width:1200px;
    margin:80px auto;
    background:#f0f8ff;
    border-radius:14px;
    padding:25px;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
}
h2{text-align:center;color:#0d47a1}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
    font-size:15px;
}
th,td{
    padding:12px;
    border:1px solid #90caf9;
    text-align:center;
}
th{background:#2196f3;color:white}

.badge-masuk{
    background:#4caf50;color:white;
    padding:5px 10px;border-radius:6px;font-weight:bold;
}
.badge-pulang{
    background:#ff7043;color:white;
    padding:5px 10px;border-radius:6px;font-weight:bold;
}
.belum{color:#f44336;font-weight:bold}

.stats{margin-top:35px}
.stat-title{font-weight:bold;color:#0d47a1;margin-bottom:10px}

.stat-bar{
    background:#e3f2fd;
    border-radius:8px;
    overflow:hidden;
    height:30px;
    margin-bottom:10px;
    position:relative;
}
.stat-fill{
    height:100%;
    width:0%;
    color:white;
    text-align:right;
    padding-right:10px;
    line-height:30px;
    font-weight:bold;
    transition:width .8s;
}
.label{position:absolute;left:10px;color:#0d47a1;font-weight:bold}

.happy{background:#42a5f5}
.sad{background:#64b5f6}
.angry{background:#1e88e5}
.scared{background:#1976d2}
.tired{background:#ffb74d}
.excited{background:#ff8a65}

.top-buttons{
    position:fixed;top:15px;right:15px;
    display:flex;flex-direction:column;gap:10px;
}
.top-buttons button{
    padding:10px 18px;border:none;border-radius:8px;
    font-weight:bold;cursor:pointer;color:white;
}
#btnAbsensi{background:#2196f3}
#btnReset{background:#f44336}

.download-btns{
    text-align:center;margin-top:25px;
}
.download-btns button{
    padding:10px 18px;
    border:none;border-radius:8px;
    font-weight:bold;cursor:pointer;color:white;
    margin:5px;
}
.excel{background:#4caf50}
.word{background:#1976d2}
</style>
</head>

<body>

<div class="top-buttons">
    <button id="btnAbsensi">‚Üí Buka Absensi</button>
    <button id="btnReset">Reset Data</button>
</div>

<div class="container">
<h2>Dashboard Guru - SD Lazuardi</h2>

<table>
<thead>
<tr>
    <th rowspan="2">Nama</th>
    <th colspan="3">Check In</th>
    <th colspan="3">Check Out</th>
</tr>
<tr>
    <th>Status</th><th>Waktu</th><th>Emoji</th>
    <th>Status</th><th>Waktu</th><th>Emoji</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="stats">
<div class="stat-title">üìä Statistik Emoji</div>

<div class="stat-bar"><div class="label">üòä Happy</div><div id="happy" class="stat-fill happy">0%</div></div>
<div class="stat-bar"><div class="label">üò¢ Sad</div><div id="sad" class="stat-fill sad">0%</div></div>
<div class="stat-bar"><div class="label">üò° Angry</div><div id="angry" class="stat-fill angry">0%</div></div>
<div class="stat-bar"><div class="label">üò± Scared</div><div id="scared" class="stat-fill scared">0%</div></div>
<div class="stat-bar"><div class="label">üò¥ Tired</div><div id="tired" class="stat-fill tired">0%</div></div>
<div class="stat-bar"><div class="label">ü§© Excited</div><div id="excited" class="stat-fill excited">0%</div></div>
</div>

<div class="download-btns">
    <button class="excel" onclick="downloadExcel()">‚¨áÔ∏è Download Excel</button>
    <button class="word" onclick="downloadWord()">‚¨áÔ∏è Download Word</button>
</div>
</div>

<script>
let absensiData = JSON.parse(localStorage.getItem("absensiData")) || [];

document.getElementById("btnAbsensi").onclick=()=>location.href="index.html";
document.getElementById("btnReset").onclick=()=>{
    if(confirm("Reset semua data?")){
        localStorage.removeItem("absensiData");
        absensiData=[];
        updateDashboard();
    }
};

/* ===== GABUNG DATA SESUAI DASHBOARD ===== */
function buildDashboardData(){
    let siswa={};

    absensiData.forEach(d=>{
        if(!siswa[d.nama]){
            siswa[d.nama]={
                nama:d.nama,
                in_status:'-',
                in_waktu:'-',
                in_emoji:'-',
                out_status:'Belum',
                out_waktu:'-',
                out_emoji:'-'
            };
        }
        if(d.status==="Check In"){
            siswa[d.nama].in_status="Check In";
            siswa[d.nama].in_waktu=d.waktu;
            siswa[d.nama].in_emoji=d.emoji;
        }
        if(d.status==="Check Out"){
            siswa[d.nama].out_status="Check Out";
            siswa[d.nama].out_waktu=d.waktu;
            siswa[d.nama].out_emoji=d.emoji;
        }
    });

    return Object.values(siswa);
}

function updateDashboard(){
    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";

    let stats={'üòä':0,'üò¢':0,'üò°':0,'üò±':0,'üò¥':0,'ü§©':0};

    const data=buildDashboardData();

    data.forEach(d=>{
        tbody.innerHTML+=`
        <tr>
            <td>${d.nama}</td>
            <td>${d.in_status==='Check In'?'<span class="badge-masuk">Check In</span>':'-'}</td>
            <td>${d.in_waktu}</td>
            <td>${d.in_emoji}</td>
            <td>${d.out_status==='Check Out'?'<span class="badge-pulang">Check Out</span>':'<span class="belum">Belum</span>'}</td>
            <td>${d.out_waktu}</td>
            <td>${d.out_emoji}</td>
        </tr>`;
    });

    absensiData.forEach(d=>{
        if(stats[d.emoji]!==undefined) stats[d.emoji]++;
    });

    const total=Object.values(stats).reduce((a,b)=>a+b,0)||1;
    setBar("happy",stats['üòä'],total);
    setBar("sad",stats['üò¢'],total);
    setBar("angry",stats['üò°'],total);
    setBar("scared",stats['üò±'],total);
    setBar("tired",stats['üò¥'],total);
    setBar("excited",stats['ü§©'],total);
}

function setBar(id,val,total){
    const p=Math.round((val/total)*100);
    const bar=document.getElementById(id);
    bar.style.width=p+"%";
    bar.textContent=p+"%";
}

/* ===== DOWNLOAD EXCEL ===== */
function downloadExcel(){
    if(absensiData.length===0){alert("Tidak ada data");return;}

    const data=buildDashboardData();
    let csv=`Nama,Check In Status,Check In Waktu,Check In Emoji,Check Out Status,Check Out Waktu,Check Out Emoji\n`;

    data.forEach(d=>{
        csv+=`${d.nama},${d.in_status},${d.in_waktu},${d.in_emoji},${d.out_status},${d.out_waktu},${d.out_emoji}\n`;
    });

    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download="dashboard_absensi_sd_lazuardi.csv";a.click();
    URL.revokeObjectURL(url);
}

/* ===== DOWNLOAD WORD ===== */
function downloadWord(){
    if(absensiData.length===0){alert("Tidak ada data");return;}

    const data=buildDashboardData();
    let html=`
    <h2 style="text-align:center;">Dashboard Absensi SD Lazuardi</h2>
    <table border="1" cellpadding="8" cellspacing="0" width="100%">
    <tr>
        <th rowspan="2">Nama</th>
        <th colspan="3">Check In</th>
        <th colspan="3">Check Out</th>
    </tr>
    <tr>
        <th>Status</th><th>Waktu</th><th>Emoji</th>
        <th>Status</th><th>Waktu</th><th>Emoji</th>
    </tr>`;

    data.forEach(d=>{
        html+=`
        <tr>
            <td>${d.nama}</td>
            <td>${d.in_status}</td>
            <td>${d.in_waktu}</td>
            <td>${d.in_emoji}</td>
            <td>${d.out_status}</td>
            <td>${d.out_waktu}</td>
            <td>${d.out_emoji}</td>
        </tr>`;
    });

    html+=`</table>`;

    const blob=new Blob(
        ['<html><body>'+html+'</body></html>'],
        {type:"application/msword"}
    );
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download="dashboard_absensi_sd_lazuardi.doc";a.click();
    URL.revokeObjectURL(url);
}

window.addEventListener("storage",()=>{
    absensiData=JSON.parse(localStorage.getItem("absensiData"))||[];
    updateDashboard();
});

updateDashboard();
</script>

</body>
</html>
